{{template "header"}}
  {{template "navbar"}}
  
    <script>
      document.title = {{.title}};
    </script>
    
    <script type="text/javascript">
            function checkInput(){
                var dsn = document.getElementById('dsn')
                var qry = document.getElementById('qry')
                var dir = document.getElementById('dir')
                
                if (dsn.value.length == 0){
                    //alert("请输入连接信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入数据库连接信息，请输入正确的数据库连接信息。";
                    document.getElementById('alert').style.display='block';
                    //document.getElementById('alert').style.width='100%';
                    return false
                }
                if (qry.value.length == 0){
                    //alert("请输入查询信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入用于导出的SQL语句，请输入正确的SQL语句。";
                    document.getElementById('alert').style.display='block';
                    //document.getElementById('alert').style.width='100%';
                    return false
                }
                if (dir.value.length == 0){
                    //alert("请输入目录信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入导出目录信息，请指定正确的导出目录。";
                    document.getElementById('alert').style.display='block';
                    //document.getElementById('alert').style.width='100%';
                    return false
                }
                return true
            }
            
            function checkDSN(){
                var dsn = document.getElementById('dsn')
                var qry = document.getElementById('qry')
                var dir = document.getElementById('dir')
                
                if (dsn.value.length == 0){
                    //alert("请输入连接信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入数据库连接信息，请输入正确的数据库连接信息。";
                    document.getElementById('alert').style.display='block';
                    //document.getElementById('alert').style.width='100%';
                }
            }
            
            function checkDSN(){
                var dsn = document.getElementById('dsn')
                
                if (dsn.value.length == 0){
                    //alert("请输入连接信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入数据库连接信息，请输入正确的数据库连接信息。";
                    document.getElementById('alert').style.display='none';
                    //document.getElementById('alert').style.width='100%';
                }
            }
            
            function checkQRY(){
                var qry = document.getElementById('qry')
                
                if (qry.value.length == 0){
                    //alert("请输入连接信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入数据库连接信息，请输入正确的数据库连接信息。";
                    document.getElementById('alert').style.display='none';
                    //document.getElementById('alert').style.width='100%';
                }
            }
            
            function checkDIR(){
                var dir = document.getElementById('dir')
                
                if (qry.value.length == 0){
                    //alert("请输入连接信息");
                    document.getElementById('warn').style.display='block';
                    document.getElementById('alert').innerHTML="您没有输入数据库连接信息，请输入正确的数据库连接信息。";
                    document.getElementById('alert').style.display='none';
                    //document.getElementById('alert').style.width='100%';
                }
            }

            function backToHome(){
                window.location.href = "/"
                return false
            }

    </script>

    <div class="container">
      <form class="form-horizontal" role="form" method="GET" action="">
        
        <div class="form-group">
          <label id="warn" class="col-sm-2 control-label" style="display: none;"> &nbsp;</label>    
          <div class="col-sm-10">
            <div id="alert" class="alert alert-danger" role="alert" style="display: none; width: 100%;"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label">字符集</label>
          <div class="col-sm-10">
            <label class="radio-inline">
              <input type="radio" name="nls" id="nls1" value="SIMPLIFIED CHINESE_CHINA.ZHS16GBK" checked> SIMPLIFIED CHINESE_CHINA.ZHS16GBK 
            </label>
            <label class="radio-inline">
              <input type="radio" name="nls" id="nls2" value="AMERICAN_AMERICA.US7ASCII"> AMERICAN_AMERICA.US7ASCII
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">连接信息</label>
          <div class="col-sm-10">
            <input id="dsn" name="dsn" type="text" class="form-control" placeholder="scott/oracle@orcl">
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">查询SQL</label>
          <div class="col-sm-10">
            <textarea id="qry" name="qry" class="form-control" rows="3" placeholder="select * from dual"></textarea>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">分隔字符</label>
          <div class="col-sm-10">
            <input id="del" name="del" type="text" class="form-control" value="~~" placeholder=".,≡,~~ 或其他" disabled>
          </div>
        </div>
        
        <div class="form-group">
          <label class="col-sm-2 control-label">包含头部</label>
          <div class="col-sm-10">
            <label class="radio-inline">
              <input type="radio" name="head" id="headN" value="N" checked> NO
            </label>
            <label class="radio-inline">
              <input type="radio" name="head" id="headY" value="Y"> YES
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">批量大小</label>
          <div class="col-sm-10">
            <label class="radio-inline">
              <input type="radio" name="batch" id="size10000" value="10000" checked> 10,000
            </label>
            <label class="radio-inline">
              <input type="radio" name="batch" id="size50000" value="50000"> 50,000
            </label>
            <label class="radio-inline">
              <input type="radio" name="batch" id="size100000" value="100000"> 100,000
            </label>
			<label class="radio-inline">
              <input type="radio" name="batch" id="size500000" value="100000"> 500,000
            </label>
			<label class="radio-inline">
              <input type="radio" name="batch" id="size0" value="0"> 0 ( 0 = Never )
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">加载模式</label>
          <div class="col-sm-10">
            <label class="radio-inline">
              <input type="radio" name="mode" id="modeInsert" value="INSERT" checked> INSERT
            </label>
            <label class="radio-inline">
              <input type="radio" name="mode" id="modeAppend" value="APPEND"> APPEND
            </label>
            <label class="radio-inline">
              <input type="radio" name="mode" id="modeReplace" value="REPLACE"> REPLACE
            </label>
            <label class="radio-inline">
              <input type="radio" name="mode" id="modeTrunc" value="TRUNCATE"> TRUNCATE
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">导出目录</label>
          <div class="col-sm-10">
            <div class="input-group">
              <input id="dir" name="dir" type="text" class="form-control" placeholder="c:\dual.txt">
              <span class="input-group-btn">
                <!--<button type="submit" class="btn btn-primary" onclick="return checkInput();" >開始導出</button>-->
				<button type="submit" class="btn btn-primary" onclick="get_package();return false;" >开始导出</button>
              </span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="col-sm-2 control-label">导出进度</label>
          <div class=" col-sm-10">
            <div id="console-wrap" style="max-height: 400px; background-color: darkgreen; color: white; margin-top: 0px; border-radius: 4px; padding: 10px; overflow-y: auto;">
            <pre id="console" style="background-color: transparent; border: none; border-radius: 0; padding: 0; color: white;"></pre>
            <div id="waiting"></div>
          </div>
          </div>
        </div>
      
      </form>
    </div>
    <!--</div>-->

	<script type="text/javascript">
	    var intervalID;

	    function keypress() {
		    if (event.keyCode == 13) {
		        get_package();
		    }
		}
	  
	    function get_package() {
		    $("#console").empty();

            var nls = $("input[name='nls']:checked").val();
            var dsn = $("#dsn").val();
            var qry = $("#qry").val();
            var del = $("#del").val();
            var head = $("input[name='head']:checked").val();
            var batch = $("input[name='batch']:checked").val();
            var mode = $("input[name='mode']:checked").val();
            var dir = $("#dir").val();

			var sock = null;
			var wsurl = "ws://"+window.location.host+"/utils/expcsv/ws?"
                            +"nls=" + nls+ "&"
                            +"dsn=" + dsn + "&"
                            +"qry=" + qry + "&"
                            +"del=" + del + "&"
                            +"head=" + head + "&"
                            +"batch=" + batch + "&"
                            +"mode=" + mode + "&"
                            +"dir=" + dir;

            console.log(wsurl);
            console.log("xxx");
				
			try {
				sock = new WebSocket(wsurl);
			} catch (e) {
				alert(e.Message);
			}

//			sock.onopen = function () {
//				console.log("connected to " + wsurl);
//		        $('#console').append("$ go get -u -v " + dsn + "\n");
//		        sock.send(dsn);
//		        intervalID = setInterval(displayProcess, 1000);
//			}

			sock.onerror = function (e) {
				console.log("err from connect " + e);
			}

			sock.onclose = function (e) {
				console.log("connection closed (" + e.code + ")");
			}

			sock.onmessage = function (e) {
				console.log("message received: " + e.data);
		        var data = eval('(' + e.data + ')');
		        if (data.type == "output") {
		            $("#console").append(data.msg + "\n");
                } else if (data.type == "command") {
		            $("#console").append("$ " + data.msg + "\n");
		        } else if (data.type == "completed") {
					$("#console").append("<strong>" + data.msg + "</strong>\n");
		            clearInterval(intervalID);
		            $('#waiting').empty();
				} else if (data.type == "error") {
					$("#console").append('<span style="color: red;">' + data.msg + '</span>\n');
		            clearInterval(intervalID);
		            $('#waiting').empty();
				}
				$("#console-wrap").scrollTop($('#console')[0].scrollHeight);
            }

		}

		function displayProcess() {
		    $('#waiting').append('.');
        }
	</script>
	
	
{{template "footer"}}